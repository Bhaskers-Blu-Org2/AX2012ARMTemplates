{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "assetLocation": {
      "type": "string",
      "metadata": {
        "description": "URI where the templates are located."
      }
    },
    "accAOSServiceAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of AOS Service Account."
      }
    },
    "accAOSServiceAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password of AOS Service Account."
      }
    },
    "accBusinessConnectorProxyAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of Business Proxy Connector Account."
      }
    },
    "accBusinessConnectorProxyAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password of Business Proxy Connector Account."
      }
    },
    "accDynamicsInstallationAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of Dynamics Installation Account."
      }
    },
    "accDynamicsInstallationAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password of Dynamics Installation Account."
      }
    },
    "accLocalAdminAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of VMs Local Administrator."
      }
    },
    "accLocalAdminAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password of VMs Local Administrator."
      }
    },
    "accSharepointServiceAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of Sharepoint Service Account."
      }
    },
    "accSharepointServiceAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password of Sharepoint Service Account."
      }
    },
    "accSqlServerServiceAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of SQL Service Account."
      }
    },
    "accSqlServerServiceAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password of SQL Service Account."
      }
    },
    "aosDnsNameForPublicIPPrefix": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the AOS Virtual Machine."
      }
    },
    "aosInstanceNamePrefix": {
      "type": "string",
      "defaultValue": "MicrosoftDynamicsAx",
      "metadata": {
        "description": "Specifies the Microsoft Dynamics AX AOS instance name"
      }
    },
    "aosLBDnsNameForPublicIP": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the AOS Load Balancer."
      }
    },
    "AOSNumberOfInstances": {
      "type": "int",
      "metadata": {
        "description": "The number of AOS instances to be deployed."
      },
      "defaultValue": "2"
    },
    "AOSVMNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "AOS VM name prefix."
      }
    },
    "AOSVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the AOS Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "AOSWsdlPort": {
      "type": "string",
      "defaultValue": "MicrosoftDynamicsAx",
      "metadata": {
        "description": "Specifies the Microsoft Dynamics AX AOS WSDL Port"
      }
    },
    "ApplicationSubnetName": {
      "type": "string",
      "metadata": {
        "description": "The virtual network application subnet name."
      }
    },
    "biDnsNameForPublicIPPrefix": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the RDS Virtual Machine."
      }
    },
    "biLBDnsNameForPublicIP": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the RDS load balancer."
      }
    },
    "BINumberOfInstances": {
      "type": "int",
      "metadata": {
        "description": "The number of BI instances to be deployed."
      },
      "defaultValue": "2"
    },
    "BIVMNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "BI VM name prefix."
      }
    },
    "BIVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the BI Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "ClientDnsNameForPublicIPPrefix": {
      "type": "string",
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the Client Virtual Machine."
      }
    },
    "ClientNumberOfInstances": {
      "type": "int",
      "metadata": {
        "description": "The number of Client instances to be deployed."
      },
      "defaultValue": "2"
    },
    "ClientVMNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Client VM name prefix."
      }
    },
    "ClientVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the Client Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "cumulativeUpdatesAndHotFixes": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Specifies the cumulative updates and hot fixes files for a slipstream installation"
      }
    },
    "dbSqlServerDatabase": {
      "type": "string",
      "defaultValue": "MicrosoftDynamicsAx",
      "metadata": {
        "description": "Specifies the Microsoft Dynamics AX database instance name"
      }
    },
    "DiagnosticsStorageType": {
      "type": "string",
      "metadata": {
        "description": "Azure Diagnostics Storage type."
      }
    },
    "domainToJoin": {
      "type": "string",
      "metadata": {
        "description": "The FQDN of the AD domain"
      }
    },
    "epDnsNameForPublicIP": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the EP Virtual Machine."
      }
    },
    "EPVMName": {
      "type": "string",
      "metadata": {
        "description": "EP VM name."
      }
    },
    "EPVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the EP Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "FileAxLicenseUri": {
      "type": "string",
      "metadata": {
        "description": "The Dynamics AX license file."
      }
    },
    "FileAxSetupPath": {
      "type": "string",
      "metadata": {
        "description": "The Dynamics AX setup executable path."
      }
    },
    "FileAxSetupUpdatesPath": {
      "type": "string",
      "metadata": {
        "description": "The Dynamics AX setup updates path."
      }
    },
    "FileAxSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The Dynamics AX setup file."
      }
    },
    "FileMSChartSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The MS chart setup file location."
      }
    },
    "FileReportViewerSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The Report Viewer setup file location."
      }
    },
    "FileSharePointUpdateSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The Sharepoint update setup file location."
      }
    },
    "FileSqlADOMDSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server ADOMD.NET setup file location."
      }
    },
    "FileSqlAMOSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server Analysis Management Objects setup file location."
      }
    },
    "FileSqlServerNativeClientSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server Native Client 2012 setup file location."
      }
    },
    "FileSqlSharedManagementObjectsSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server Shared Management Objects setup file location."
      }
    },
    "FileSqlSysClrTypesSetupUri": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server System CLR Types setup file location."
      }
    },
    "RDSCertificatePassword": {
      "type": "string",
      "metadata": {
        "description": "The digital certificate password for RDS roles."
      }
    },
    "RDSDnsNameForPublicIPPrefix": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the RDS Virtual Machine."
      }
    },
    "RDSFarmName": {
      "type": "string",
      "metadata": {
        "description": "The RDS farm name."
      }
    },
    "rdsLBDnsNameForPublicIP": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the RDS Load Balancer."
      }
    },
    "RDSNumberOfInstances": {
      "type": "int",
      "metadata": {
        "description": "The number of RDS instances to be deployed."
      },
      "defaultValue": "2"
    },
    "RDSStaticPrivateIpPrefix": {
      "type": "string",
      "metadata": {
        "description": "The RDS static private IP prefix (example: 10.2.0.)."
      }
    },
    "RDSStaticPrivateIpValue": {
      "type": "int",
      "metadata": {
        "description": "The start value of RDS static private IP."
      }
    },
    "RDSVMNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "RDS VM name."
      }
    },
    "RDSVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the RDS Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "spFarmPassphrase": {
      "type": "string",
      "metadata": {
        "description": "The SharePoint Web Farm passphrase"
      }
    },
    "SQLAlwaysOnAvailabilityGroupListenerName": {
      "type": "string",
      "metadata": {
        "description": "SQL Server AlwaysOn availability group listener name."
      }
    },
    "SQLAlwaysOnAvailabilityGroupName": {
      "type": "string",
      "metadata": {
        "description": "SQL Server AlwaysOn availability group name."
      }
    },
    "SQLAlwaysOnClusterName": {
      "type": "string",
      "metadata": {
        "description": "SQL Server AlwaysOn cluster name."
      }
    },
    "SQLAlwaysOnEndpointName": {
      "type": "string",
      "metadata": {
        "description": "SQL Server AlwaysOn endpoint name."
      }
    },
    "sqlDnsNameForPublicIPPrefix": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the SQL Server Virtual Machine."
      }
    },
    "SQLLoadBalancerPrivateIPAddress": {
      "type": "string",
      "metadata": {
        "description": "The sql server load balancer private ip address."
      }
    },
    "SQLServerSubnetName": {
      "type": "string",
      "metadata": {
        "description": "The virtual network SQL Server subnet name."
      }
    },
    "SQLVMDataDiskSize": {
      "type": "int",
      "metadata": {
        "description": "The SQL Server Virtual Machine Data disk size."
      },
      "defaultValue": 1023
    },
    "SQLVMNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "SQL VM name prefix."
      }
    },
    "SQLVMNumberOfDataDisk": {
      "type": "string",
      "allowedValues": [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "32"
      ],
      "metadata": {
        "description": "The SQL Server Virtual Machine number of data disk."
      }
    },
    "SQLVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the SQL Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "sqlWitDnsNameForPublicIP": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Globally unique DNS Name for the Public IP used to access the SQL Server Witness Virtual Machine."
      }
    },
    "SQLWitnessVMName": {
      "type": "string",
      "metadata": {
        "description": "SQL Witness VM name."
      }
    },
    "SQLWitnessVMSize": {
      "type": "string",
      "metadata": {
        "description": "The VM size for the SQL Virtual Machine."
      },
      "allowedValues": [
        "Standard_D1",
        "Standard_DS1",
        "Standard_D2",
        "Standard_DS2",
        "Standard_D3",
        "Standard_DS3",
        "Standard_D4",
        "Standard_DS4",
        "Standard_D11",
        "Standard_DS11",
        "Standard_D12",
        "Standard_DS12",
        "Standard_D13",
        "Standard_DS13",
        "Standard_D14",
        "Standard_DS14"
      ]
    },
    "StorageType": {
      "type": "string",
      "metadata": {
        "description": "Azure Storage type."
      }
    },
    "VirtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "Virtual Network Name."
      }
    },
    "VirtualNetworkResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Virtual Network Resource Group."
      }
    }
  },
  "variables": {
    // Common variables
    "ApplicationSubnetRef": "[concat(variables('vnetId'), '/subnets/', parameters('ApplicationSubnetName'))]",
    "assetLocation": "[parameters('assetLocation')]",
    "deploymentApiVersion": "2016-06-01",
    "DiagnosticsStorageName": "[concat('diagstorage', uniqueString(resourceGroup().id))]",
    "DSCModuleLocation": "[parameters('assetLocation')]",
    "publicIPAddressType": "Dynamic",
    "resourcesApiVersion": "2015-06-15",
    "SQLServerSubnetRef": "[concat(variables('vnetId'), '/subnets/', parameters('SQLServerSubnetName'))]",
    "StorageName": "[concat('storage', uniqueString(resourceGroup().id))]",
    "vhdStorageContainerName": "vhds",
    "vnetId": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks', parameters('VirtualNetworkName'))]",

    // AOS variables
    "AOSTemplateURL": "[concat(variables('assetLocation'), '/AOSTemplate.json')]",
    "AOSVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/AOSConfiguration.ps1.zip')]",
    "AOSVMMachine0DSCConfigurationFunction": "AOSConfiguration.ps1\\AOSMachine0",
    "AOSVMMachine1NDSCConfigurationFunction": "AOSConfiguration.ps1\\AOSMachine1N",

    // BI variables
    "BITemplateURL": "[concat(variables('assetLocation'), '/BITemplate.json')]",
    "BIVMDSCConfigurationFunction": "BIConfiguration.ps1\\BIMachine",
    "BIVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/BIConfiguration.ps1.zip')]",

    // Client variables
    "ClientTemplateURL": "[concat(variables('assetLocation'), '/ClientTemplate.json')]",
    "ClientVMDSCConfigurationFunction": "ClientConfiguration.ps1\\ClientMachine",
    "ClientVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/ClientConfiguration.ps1.zip')]",

    // DSC variables
    "DSCTemplateURL": "[concat(variables('assetLocation'), '/DSCTemplate.json')]",

    // Disk selection variables
    "DiskSelectionTemplateURL": "[concat(variables('assetLocation'), '/DiskSelectionTemplate.json')]",

    // EP variables
    "EPTemplateURL": "[concat(variables('assetLocation'), '/EPTemplate.json')]",
    "EPVMDataDiskSize": "128",
    "EPVMDSCConfigurationFunction": "EPConfiguration.ps1\\EPMachine",
    "EPVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/EPConfiguration.ps1.zip')]",

    // RDS variables
    "RDSTemplateURL": "[concat(variables('assetLocation'), '/RDSTemplate.json')]",
    "RDSVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/RDSConfiguration.ps1.zip')]",
    "RDSVMMachine0DSCConfigurationFunction": "RDSConfiguration.ps1\\RDSMachine0",
    "RDSVMMachine1NDSCConfigurationFunction": "RDSConfiguration.ps1\\RDSMachine1N",

    // SQL AlwaysOn variables
    "SQLAlwaysOnTemplateURL": "[concat(variables('assetLocation'), '/SQLAlwaysOnTemplate.json')]",
    "SQLVMCreateClusterDSCConfigurationFunction": "DatabaseConfiguration.ps1\\SQLAlwaysOnCreateCluster",
    "SQLVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/DatabaseConfiguration.ps1.zip')]",
    "SQLVMPrepareDSCConfigurationFunction": "DatabaseConfiguration.ps1\\SQLAlwaysOnPrepare",

    // SQL Witness variables
    "SQLWitnessSharePath": "sqlwitshare",
    "SQLWitnessTemplateURL": "[concat(variables('assetLocation'), '/SQLWitnessTemplate.json')]",
    "SQLWitnessVMDataDiskSize": "128",
    "SQLWitnessVMDSCConfigurationFunction": "DatabaseConfiguration.ps1\\SQLWitnessMachine",
    "SQLWitnessVMDSCModuleUrl": "[concat(variables('DSCModuleLocation'), '/DatabaseConfiguration.ps1.zip')]",

    //SQL Load Balancer
    "SQLLoadBalancerName": "SQLLoadBalancer"
  },
  "resources": [
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('StorageName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "StorageAccount"
      },
      "properties": {
        "accountType": "[parameters('StorageType')]"
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('DiagnosticsStorageName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "DiagnosticsStorageAccount"
      },
      "properties": {
        "accountType": "[parameters('DiagnosticsStorageType')]"
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "SQLWitnessDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('SQLWitnessTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "SQLWitnessDnsNameForPublicIP": { "value": "[parameters('SQLWitDnsNameForPublicIP')]" },
          "SQLWitnessSharePath": { "value": "[variables('SQLWitnessSharePath')]" },
          "SQLWitnessVMDataDiskSize": { "value": "[variables('SQLWitnessVMDataDiskSize')]" },
          "SQLWitnessVMName": { "value": "[parameters('SQLWitnessVMName')]" },
          "SQLWitnessVMSize": { "value": "[parameters('SQLWitnessVMSize')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('SQLServerSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "SQLAlwaysOnDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('SQLAlwaysOnTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "deploymentApiVersion": { "value": "[variables('deploymentApiVersion')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "DiskSelectionTemplateURL": { "value": "[variables('DiskSelectionTemplateURL')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "SQLDnsNameForPublicIPPrefix": { "value": "[parameters('SQLDnsNameForPublicIPPrefix')]" },
          "SQLLoadBalancerPrivateIPAddress": { "value": "[parameters('SQLLoadBalancerPrivateIPAddress')]" },
          "SQLVMDataDiskSize": { "value": "[parameters('SQLVMDataDiskSize')]" },
          "SQLVMNamePrefix": { "value": "[parameters('SQLVMNamePrefix')]" },
          "SQLVMNumberOfDataDisk": { "value": "[parameters('SQLVMNumberOfDataDisk')]" },
          "SQLVMSize": { "value": "[parameters('SQLVMSize')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('SQLServerSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "AOSDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('AOSTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "AOSDnsNameForPublicIPPrefix": { "value": "[parameters('AOSDnsNameForPublicIPPrefix')]" },
          "AOSLBDnsNameForPublicIP": { "value": "[parameters('AOSLBDnsNameForPublicIP')]" },
          "AOSNumberOfInstances": { "value": "[parameters('AOSnumberOfInstances')]" },
          "AOSVMNamePrefix": { "value": "[parameters('AOSVMNamePrefix')]" },
          "AOSVMSize": { "value": "[parameters('AOSVMSize')]" },
          "AOSWsdlPort": { "value": "[parameters('AOSWsdlPort')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('ApplicationSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "ClientDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('ClientTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "ClientDnsNameForPublicIPPrefix": { "value": "[parameters('ClientDnsNameForPublicIPPrefix')]" },
          "ClientNumberOfInstances": { "value": "[parameters('ClientNumberOfInstances')]" },
          "ClientVMNamePrefix": { "value": "[parameters('ClientVMNamePrefix')]" },
          "ClientVMSize": { "value": "[parameters('ClientVMSize')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('ApplicationSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "RDSDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('RDSTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "RDSDnsNameForPublicIPPrefix": { "value": "[parameters('RDSDnsNameForPublicIPPrefix')]" },
          "RDSLBDnsNameForPublicIP": { "value": "[parameters('RDSLBDnsNameForPublicIP')]" },
          "RDSNumberOfInstances": { "value": "[parameters('RDSNumberOfInstances')]" },
          "RDSStaticPrivateIpPrefix": { "value": "[parameters('RDSStaticPrivateIpPrefix')]" },
          "RDSStaticPrivateIpValue": { "value": "[parameters('RDSStaticPrivateIpValue')]" },
          "RDSVMNamePrefix": { "value": "[parameters('RDSVMNamePrefix')]" },
          "RDSVMSize": { "value": "[parameters('RDSVMSize')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('ApplicationSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "BIDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('BITemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "BIDnsNameForPublicIPPrefix": { "value": "[parameters('BIDnsNameForPublicIPPrefix')]" },
          "BILBDnsNameForPublicIP": { "value": "[parameters('BILBDnsNameForPublicIP')]" },
          "BINumberOfInstances": { "value": "[parameters('BINumberOfInstances')]" },
          "BIVMNamePrefix": { "value": "[parameters('BIVMNamePrefix')]" },
          "BIVMSize": { "value": "[parameters('BIVMSize')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('ApplicationSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('deploymentApiVersion')]",
      "type": "Microsoft.Resources/deployments",
      "name": "EPDeployment",
      "dependsOn": [ "[variables('StorageName')]", "[variables('DiagnosticsStorageName')]" ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('EPTemplateURL')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adminPassword": { "value": "[parameters('accLocalAdminAccountPassword')]" },
          "adminUsername": { "value": "[parameters('accLocalAdminAccountName')]" },
          "apiVersion": { "value": "[variables('resourcesApiVersion')]" },
          "diagnosticsStorageName": { "value": "[variables('DiagnosticsStorageName')]" },
          "EPDnsNameForPublicIP": { "value": "[parameters('EPDnsNameForPublicIP')]" },
          "EPVMDataDiskSize": { "value": "[variables('EPVMDataDiskSize')]" },
          "EPVMName": { "value": "[parameters('EPVMName')]" },
          "EPVMSize": { "value": "[parameters('EPVMSize')]" },
          "publicIPAddressType": { "value": "[variables('publicIPAddressType')]" },
          "StorageName": { "value": "[variables('StorageName')]" },
          "subnetRef": { "value": "[variables('ApplicationSubnetRef')]" },
          "vhdStorageContainerName": { "value": "[variables('vhdStorageContainerName')]" }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('SQLWitnessVMName'), '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "SQLWitnessDSC"
      },
      "dependsOn": [
        "SQLWitnessDeployment",
        "SQLAlwaysOnDeployment",
        "AOSDeployment",
        "ClientDeployment",
        "RDSDeployment",
        "BIDeployment",
        "EPDeployment"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('SQLWitnessVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('SQLWitnessVMDSCConfigurationFunction')]",
          "Properties": {
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "SharePath": "[variables('SQLWitnessSharePath')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('SQLVMNamePrefix'), 0, '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "SQLDSC0"
      },
      "dependsOn": [
        "SQLWitnessDeployment",
        "SQLAlwaysOnDeployment",
        "AOSDeployment",
        "ClientDeployment",
        "RDSDeployment",
        "BIDeployment",
        "EPDeployment"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('SQLVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('SQLVMPrepareDSCConfigurationFunction')]",
          "Properties": {
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "LocalAdminCreds": {
              "UserName": "[parameters('accLocalAdminAccountName')]",
              "Password": "PrivateSettingsRef:AccLocalAdminAccountPassword"
            },
            "SqlAlwaysOnEndpointName": "[parameters('SQLAlwaysOnEndpointName')]",
            "SqlServiceCreds": {
              "UserName": "[parameters('accSqlServerServiceAccountName')]",
              "Password": "PrivateSettingsRef:AccSqlServerServiceAccountPassword"
            }
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]",
            "AccLocalAdminAccountPassword": "[parameters('accLocalAdminAccountPassword')]",
            "AccSqlServerServiceAccountPassword": "[parameters('accSqlServerServiceAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('SQLVMNamePrefix'), 1, '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "SQLDSC1"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('SQLVMNamePrefix'), 0), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('SQLVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('SQLVMCreateClusterDSCConfigurationFunction')]",
          "Properties": {
            "ClusterName": "[parameters('SQLAlwaysOnClusterName')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "dbSqlServerDatabase": "[parameters('dbSqlServerDatabase')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "LBAddress": "[parameters('SQLLoadBalancerPrivateIPAddress')]",
            "LBName": "[variables('SQLLoadBalancerName')]",
            "LocalAdminCreds": {
              "UserName": "[parameters('accLocalAdminAccountName')]",
              "Password": "PrivateSettingsRef:AccLocalAdminAccountPassword"
            },
            "Nodes": [ "[concat(parameters('SQLVMNamePrefix'),'0')]", "[concat(parameters('SQLVMNamePrefix'),'1')]" ],
            "PrimaryReplica": "[concat(parameters('SQLVMNamePrefix'),'1')]",
            "SecondaryReplica": "[concat(parameters('SQLVMNamePrefix'),'0')]",
            "SharePath": "[concat('\\\\', parameters('SQLWitnessVMName'), '\\', variables('SQLWitnessSharePath'))]",
            "SqlAlwaysOnAvailabilityGroupListenerName": "[parameters('SQLAlwaysOnAvailabilityGroupListenerName')]",
            "SqlAlwaysOnAvailabilityGroupName": "[parameters('SQLAlwaysOnAvailabilityGroupName')]",
            "SqlAlwaysOnEndpointName": "[parameters('SQLAlwaysOnEndpointName')]",
            "SqlServiceCreds": {
              "UserName": "[parameters('accSqlServerServiceAccountName')]",
              "Password": "PrivateSettingsRef:AccSqlServerServiceAccountPassword"
            }
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]",
            "AccLocalAdminAccountPassword": "[parameters('accLocalAdminAccountPassword')]",
            "AccSqlServerServiceAccountPassword": "[parameters('accSqlServerServiceAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('AOSVMNamePrefix'), 0, '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "AOSDSC0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('SQLVMNamePrefix'), 1), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('AOSVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('AOSVMMachine0DSCConfigurationFunction')]",
          "Properties": {
            "aosAccount": "[parameters('accAOSServiceAccountName')]",
            "aosAccountPassword": "[parameters('accAOSServiceAccountPassword')]",
            "aosInstanceName": "[concat(parameters('AOSInstanceNamePrefix'), 0)]",
            "aosWsdlPort": "[parameters('AOSWsdlPort')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "dbSqlServer": "[parameters('SQLAlwaysOnAvailabilityGroupListenerName')]",
            "dbSqlServerDatabase": "[parameters('dbSqlServerDatabase')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxLicenseUri": "[parameters('FileAxLicenseUri')]",
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "fileMSChartSetupUri": "[parameters('FileMSChartSetupUri')]",
            "fileReportViewerSetupUri": "[parameters('FileReportViewerSetupUri')]",
            "fileSqlADOMDSetupUri": "[parameters('FileSqlADOMDSetupUri')]",
            "fileSqlAMOSetupUri": "[parameters('FileSqlAMOSetupUri')]",
            "fileSqlSysClrTypesSetupUri": "[parameters('FileSqlSysClrTypesSetupUri')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('AOSVMNamePrefix'), add(copyindex(), 1), '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "AOSDSC1N"
      },
      "copy": {
        "name": "aosDSCLoop",
        "count": "[sub(parameters('AOSNumberOfInstances'), 1)]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('AOSVMNamePrefix'), 0), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('AOSVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('AOSVMMachine1NDSCConfigurationFunction')]",
          "Properties": {
            "aosAccount": "[parameters('accAOSServiceAccountName')]",
            "aosAccountPassword": "[parameters('accAOSServiceAccountPassword')]",
            "aosInstanceName": "[concat(parameters('AOSInstanceNamePrefix'), add(copyindex(), 1))]",
            "aosWsdlPort": "[parameters('AOSWsdlPort')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "dbSqlServer": "[parameters('SQLAlwaysOnAvailabilityGroupListenerName')]",
            "dbSqlServerDatabase": "[parameters('dbSqlServerDatabase')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "fileMSChartSetupUri": "[parameters('FileMSChartSetupUri')]",
            "fileSqlADOMDSetupUri": "[parameters('FileSqlADOMDSetupUri')]",
            "fileSqlAMOSetupUri": "[parameters('FileSqlAMOSetupUri')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('BIVMNamePrefix'), '0', '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "BIDSC0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('AOSVMNamePrefix'), '0'), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('BIVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('BIVMDSCConfigurationFunction')]",
          "Properties": {
            "aosServer": "[concat(parameters('AOSVMNamePrefix'), '0')]",
            "aosWsdlPort": "[parameters('aosWsdlPort')]",
            "bcProxyAccount": "[parameters('accBusinessConnectorProxyAccountName')]",
            "bcProxyAccountPassword": "[parameters('accBusinessConnectorProxyAccountPassword')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "dbSqlServer": "[parameters('SQLAlwaysOnAvailabilityGroupListenerName')]",
            "dbSqlServerDatabase": "[parameters('dbSqlServerDatabase')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "restartAOS": false
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('BIVMNamePrefix'), add(copyindex(), 1), '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "BIDSC1N"
      },
      "copy": {
        "name": "biDSCLoop",
        "count": "[sub(parameters('BINumberOfInstances'), 1)]"
      },
      "dependsOn": [
        "aosDSCLoop",
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('BIVMNamePrefix'), 0), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('BIVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('BIVMDSCConfigurationFunction')]",
          "Properties": {
            "aosServer": "[concat(parameters('AOSVMNamePrefix'), add(copyindex(), 1))]",
            "aosWsdlPort": "[parameters('aosWsdlPort')]",
            "bcProxyAccount": "[parameters('accBusinessConnectorProxyAccountName')]",
            "bcProxyAccountPassword": "[parameters('accBusinessConnectorProxyAccountPassword')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "dbSqlServer": "[parameters('SQLAlwaysOnAvailabilityGroupListenerName')]",
            "dbSqlServerDatabase": "[parameters('dbSqlServerDatabase')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "restartAOS": true
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('ClientVMNamePrefix'), copyindex(), '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "ClientDSC"
      },
      "copy": {
        "name": "clientDSCLoop",
        "count": "[parameters('ClientNumberOfInstances')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('AOSVMNamePrefix'), 0), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('ClientVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('ClientVMDSCConfigurationFunction')]",
          "Properties": {
            "aosServer": "[concat(parameters('AOSLBDnsNameForPublicIP'), '.', resourceGroup().location, '.cloudapp.azure.com')]",
            "aosWsdlPort": "[parameters('AOSWsdlPort')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "fileMSChartSetupUri": "[parameters('FileMSChartSetupUri')]",
            "fileReportViewerSetupUri": "[parameters('FileReportViewerSetupUri')]",
            "fileSqlADOMDSetupUri": "[parameters('FileSqlADOMDSetupUri')]",
            "fileSqlAMOSetupUri": "[parameters('FileSqlAMOSetupUri')]",
            "fileSqlSysClrTypesSetupUri": "[parameters('FileSqlSysClrTypesSetupUri')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('EPVMName'), '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "EPDSC"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('AOSVMNamePrefix'), 0), 'dsc')]",
        "clientDSCLoop"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('EPVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('EPVMDSCConfigurationFunction')]",
          "Properties": {
            "aosServer": "[concat(parameters('AOSVMNamePrefix'), 0)]",
            "aosWsdlPort": "[parameters('AOSWsdlPort')]",
            "bcProxyAccount": "[parameters('accBusinessConnectorProxyAccountName')]",
            "bcProxyAccountPassword": "[parameters('accBusinessConnectorProxyAccountPassword')]",
            "cumulativeUpdatesAndHotFixes": "[parameters('cumulativeUpdatesAndHotFixes')]",
            "dbSqlServer": "[parameters('SQLAlwaysOnAvailabilityGroupListenerName')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "fileAxSetupPath": "[parameters('FileAxSetupPath')]",
            "fileAxSetupUpdatesPath": "[parameters('FileAxSetupUpdatesPath')]",
            "fileAxSetupUri": "[parameters('FileAxSetupUri')]",
            "fileMSChartSetupUri": "[parameters('FileMSChartSetupUri')]",
            "fileReportViewerSetupUri": "[parameters('FileReportViewerSetupUri')]",
            "fileSharePointUpdateSetupUri": "[parameters('FileSharePointUpdateSetupUri')]",
            "fileSqlAMOSetupUri": "[parameters('FileSqlAMOSetupUri')]",
            "fileSqlSysClrTypesSetupUri": "[parameters('FileSqlSysClrTypesSetupUri')]",
            "SharePointAccountCreds": {
              "UserName": "[parameters('accSharepointServiceAccountName')]",
              "Password": "PrivateSettingsRef:AccSharepointServiceAccountPassword"
            },
            "spFarmPassphrase": "[parameters('spFarmPassphrase')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]",
            "AccSharepointServiceAccountPassword": "[parameters('accSharepointServiceAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('RDSVMNamePrefix'), '0/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "RDSDSC0"
      },
      "dependsOn": [ "clientDSCLoop", "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('SQLVMNamePrefix'), 1), 'dsc')]" ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('RDSVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('RDSVMMachine0DSCConfigurationFunction')]",
          "Properties": {
            "ClientAccessName": "[concat(parameters('RDSFarmName'), '.', parameters('domainToJoin'))]",
            "ClientNumberOfInstances": "[parameters('ClientNumberOfInstances')]",
            "ClientVMNamePrefix": "[parameters('ClientVMNamePrefix')]",
            "ConnectionBrokerVMName": "[concat(parameters('RDSVMNamePrefix'), '0')]",
            "dbSqlServer": "[concat(parameters('SQLVMNamePrefix'), '1')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "FileSqlServerNativeClientSetupUri": "[parameters('FileSqlServerNativeClientSetupUri')]",
            "FileSqlSharedManagementObjectsSetupUri": "[parameters('FileSqlSharedManagementObjectsSetupUri')]",
            "FileSqlSysClrTypesSetupUri": "[parameters('FileSqlSysClrTypesSetupUri')]",
            "LoadBalancerFqdn": "[concat(parameters('RDSLBDnsNameForPublicIP'), '.', resourceGroup().location, '.cloudapp.azure.com')]",
            "RDSCertificatePassword": "[parameters('RDSCertificatePassword')]",
            "RDSIndex": "0",
            "RDSNumberOfInstances": "[parameters('RDSNumberOfInstances')]",
            "RDSStaticPrivateIpPrefix": "[parameters('RDSStaticPrivateIpPrefix')]",
            "RDSStaticPrivateIpValue": "[parameters('RDSStaticPrivateIpValue')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    },
    {
      "apiVersion": "[variables('resourcesApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('RDSVMNamePrefix'), add(copyindex(), 1), '/dsc')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "RDSDSC1N"
      },
      "copy": {
        "name": "rdsDSCLoop",
        "count": "[sub(parameters('RDSNumberOfInstances'), 1)]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(parameters('RDSVMNamePrefix'), 0), 'dsc')]"
      ],
      "properties": {
        "publisher": "Microsoft.Powershell",
        "type": "DSC",
        "typeHandlerVersion": "2.15",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "ModulesUrl": "[variables('RDSVMDSCModuleUrl')]",
          "ConfigurationFunction": "[variables('RDSVMMachine1NDSCConfigurationFunction')]",
          "Properties": {
            "ConnectionBrokerVMName": "[concat(parameters('RDSVMNamePrefix'), '0')]",
            "dbSqlServer": "[concat(parameters('SQLVMNamePrefix'), '1')]",
            "DomainName": "[parameters('domainToJoin')]",
            "DynamicsInstallationCreds": {
              "UserName": "[parameters('accDynamicsInstallationAccountName')]",
              "Password": "PrivateSettingsRef:AccDynamicsInstallationAccountPassword"
            },
            "FileSqlServerNativeClientSetupUri": "[parameters('FileSqlServerNativeClientSetupUri')]",
            "FileSqlSharedManagementObjectsSetupUri": "[parameters('FileSqlSharedManagementObjectsSetupUri')]",
            "FileSqlSysClrTypesSetupUri": "[parameters('FileSqlSysClrTypesSetupUri')]",
            "LoadBalancerFqdn": "[concat(parameters('RDSLBDnsNameForPublicIP'), '.', resourceGroup().location, '.cloudapp.azure.com')]",
            "RDSCertificatePassword": "[parameters('RDSCertificatePassword')]",
            "RDSIndex": "[add(copyindex(), 1)]",
            "RDSNumberOfInstances": "[parameters('RDSNumberOfInstances')]",
            "RDSStaticPrivateIpPrefix": "[parameters('RDSStaticPrivateIpPrefix')]",
            "RDSStaticPrivateIpValue": "[parameters('RDSStaticPrivateIpValue')]"
          }
        },
        "protectedSettings": {
          "Items": {
            "AccDynamicsInstallationAccountPassword": "[parameters('accDynamicsInstallationAccountPassword')]"
          }
        }
      }
    }
  ]
}
